<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>給料データ管理ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .tab.active {
            background: #4facfe;
            color: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: #4facfe;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .employee-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .employee-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #333;
            font-size: 1.2em;
        }

        .employee-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .family-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .family-title {
            font-weight: 600;
            color: #333;
        }

        .family-list {
            display: grid;
            gap: 10px;
        }

        .family-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #56ab2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-info {
            flex: 1;
        }

        .family-name {
            font-weight: 600;
            color: #333;
        }

        .family-details {
            color: #666;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .family-actions {
            display: flex;
            gap: 5px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 0.8em;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .salary-items {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #56ab2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .item-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .salary-inputs {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .salary-input-group {
            display: flex;
            flex-direction: column;
        }

        .salary-input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .salary-input-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .salary-input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .section-header {
            background: #e9ecef;
            padding: 10px 15px;
            margin: 15px 0 10px 0;
            border-radius: 6px;
            font-weight: 600;
            color: #495057;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .salary-data-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-data-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f093fb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .salary-data-info {
            flex: 1;
        }

        .salary-data-name {
            font-weight: 600;
            color: #333;
        }

        .salary-data-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .salary-data-actions {
            display: flex;
            gap: 10px;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .type-attendance {
            background: #fff3cd;
            color: #856404;
        }

        .type-income {
            background: #d4edda;
            color: #155724;
        }

        .type-deduction {
            background: #f8d7da;
            color: #721c24;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .row, .row-3, .salary-input-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 8px;
                margin-bottom: 5px;
            }

            .data-table {
                font-size: 0.9em;
            }

            .data-table th, .data-table td {
                padding: 8px;
            }

            .employee-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .family-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 給料データ管理ツール</h1>
            <p>従業員データの管理・CSV生成・メール送信を簡単に</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab" onclick="showTab('employees')">👥 従業員管理</button>
                <button class="tab" onclick="showTab('items')">📋 項目管理</button>
                <button class="tab active" onclick="showTab('salary')">💰 給料入力</button>
                <button class="tab" onclick="showTab('data')">📊 データ管理</button>
                <button class="tab" onclick="showTab('generate')">📈 CSV生成</button>
                <button class="tab" onclick="showTab('email')">📧 メール送信</button>
            </div>

            <!-- 従業員管理タブ -->
            <div id="employees" class="tab-content">
                <h2>従業員管理</h2>
                <form id="employeeForm">
                    <input type="hidden" id="editEmployeeId">
                    <div class="row">
                        <div class="form-group">
                            <label for="empName">氏名 *</label>
                            <input type="text" id="empName" required>
                        </div>
                        <div class="form-group">
                            <label for="empId">従業員ID *</label>
                            <input type="text" id="empId" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="empGender">性別</label>
                            <select id="empGender">
                                <option value="">選択してください</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="empBirthDate">生年月日</label>
                            <input type="date" id="empBirthDate">
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="empDepartment">部署</label>
                            <select id="empDepartment">
                                <option value="">選択してください</option>
                                <option value="営業部">営業部</option>
                                <option value="開発部">開発部</option>
                                <option value="人事部">人事部</option>
                                <option value="経理部">経理部</option>
                                <option value="総務部">総務部</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="empPosition">役職</label>
                            <select id="empPosition">
                                <option value="">選択してください</option>
                                <option value="一般社員">一般社員</option>
                                <option value="主任">主任</option>
                                <option value="課長">課長</option>
                                <option value="部長">部長</option>
                                <option value="取締役">取締役</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="empPostalCode">郵便番号</label>
                        <input type="text" id="empPostalCode" placeholder="例: 123-4567">
                    </div>

                    <div class="form-group">
                        <label for="empAddress">住所</label>
                        <textarea id="empAddress" rows="3" placeholder="都道府県市区町村番地"></textarea>
                    </div>

                    <button type="submit" class="btn" id="employeeSubmitBtn">従業員を追加</button>
                    <button type="button" class="btn btn-secondary" onclick="clearEmployeeForm()">フォームクリア</button>
                    <button type="button" class="btn btn-warning" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">編集キャンセル</button>
                </form>

                <div id="employeeList" class="employee-list">
                    <p>従業員データがありません。</p>
                </div>
            </div>

            <!-- 項目管理タブ -->
            <div id="items" class="tab-content">
                <h2>給料項目管理</h2>
                <form id="itemForm">
                    <div class="row">
                        <div class="form-group">
                            <label for="itemName">項目名 *</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemType">項目タイプ *</label>
                            <select id="itemType" required>
                                <option value="">選択してください</option>
                                <option value="attendance">勤怠項目</option>
                                <option value="income">収入項目</option>
                                <option value="deduction">控除項目</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemDescription">説明</label>
                        <textarea id="itemDescription" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">項目を追加</button>
                    <button type="button" class="btn btn-secondary" onclick="clearItemForm()">フォームクリア</button>
                </form>

                <div id="itemList" class="salary-items">
                    <p>給料項目がありません。</p>
                </div>
            </div>

            <!-- 給料入力タブ -->
            <div id="salary" class="tab-content active">
                <h2>給料データ入力</h2>
                <form id="salaryForm">
                    <div class="row">
                        <div class="form-group">
                            <label for="selectedEmployee">従業員選択 *</label>
                            <select id="selectedEmployee" required onchange="loadSalaryData()">
                                <option value="">従業員を選択してください</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="salaryMonth">対象月 *</label>
                            <input type="month" id="salaryMonth" required onchange="loadSalaryData()">
                        </div>
                    </div>

                    <div id="salaryInputs" class="salary-inputs">
                        <h3>給料項目</h3>
                        <p>項目管理タブで項目を追加してください。</p>
                    </div>

                    <button type="submit" class="btn">給料データを保存</button>
                    <button type="button" class="btn btn-secondary" onclick="clearSalaryForm()">フォームクリア</button>
                </form>
            </div>

            <!-- データ管理タブ -->
            <div id="data" class="tab-content">
                <h2>給料データ管理</h2>
                <div class="row">
                    <div class="form-group">
                        <button class="btn btn-danger" onclick="deleteAllSalaryData()">全給料データを削除</button>
                        <button class="btn btn-warning" onclick="exportAllData()">全データをエクスポート</button>
                        <button class="btn btn-success" onclick="importData()">データをインポート</button>
                    </div>
                </div>

                <div class="form-group" style="display: none;" id="importSection">
                    <label for="importFile">JSONファイルを選択</label>
                    <input type="file" id="importFile" accept=".json" onchange="handleFileSelect(event)">
                    <button class="btn btn-secondary" onclick="confirmImport()" id="confirmImportBtn" style="display: none;">インポート実行</button>
                    <button class="btn btn-danger" onclick="cancelImport()">キャンセル</button>
                </div>

                <div id="salaryDataList" class="salary-data-list">
                    <p>給料データがありません。</p>
                </div>
            </div>

            <!-- CSV生成タブ -->
            <div id="generate" class="tab-content">
                <h2>CSVファイル生成</h2>
                <div class="row">
                    <div class="form-group">
                        <label for="csvMonth">対象月選択</label>
                        <input type="month" id="csvMonth" onchange="updateSummary()">
                    </div>
                </div>
                
                <div id="summaryCard" class="summary-card" style="display: none;">
                    <h3>給料サマリー</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" id="totalEmployees">0</div>
                            <div class="summary-label">従業員数</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalSalary">¥0</div>
                            <div class="summary-label">総給料</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="avgSalary">¥0</div>
                            <div class="summary-label">平均給料</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="generateCSV()">CSVファイルを生成・ダウンロード</button>
                <button class="btn btn-secondary" onclick="previewCSV()">プレビュー表示</button>
                
                <div id="csvPreview" style="display: none;">
                    <h3>CSVプレビュー</h3>
                    <div style="overflow-x: auto;">
                        <table id="csvTable" class="data-table">
                            <!-- CSVデータがここに表示されます -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- メール送信タブ -->
            <div id="email" class="tab-content">
                <h2>データ送信</h2>
                
                <div class="form-group">
                    <label for="emailTo">送信先メールアドレス *</label>
                    <input type="email" id="emailTo" required placeholder="example@company.com">
                </div>
                
                <div class="form-group">
                    <label for="emailSubject">件名</label>
                    <input type="text" id="emailSubject" value="給料データ">
                </div>

                <div class="form-group">
                    <label for="emailMonth">対象月選択</label>
                    <input type="month" id="emailMonth">
                </div>

                <button class="btn" onclick="createEmailFiles()">1. ファイルの作成</button>
                <button class="btn btn-secondary" onclick="launchEmailClient()">2. メールソフト起動</button>
                <button class="btn btn-primary" onclick="showDirectSubmitModal()">📤 直接送信</button>
                
                <div id="emailPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3>送信内容プレビュー</h3>
                    <div id="emailPreviewContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 直接送信モーダル -->
    <div id="directSubmitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📤 データ直接送信</h3>
                <button class="close-btn" onclick="closeDirectSubmitModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="directSubmitPassword">🔐 パスワード</label>
                <input type="password" id="directSubmitPassword" placeholder="認証用パスワードを入力してください">
                <small>データ送信のための認証パスワードを入力してください</small>
            </div>
            
            <div class="form-group">
                <label>📋 送信データの確認</label>
                <div id="directSubmitDataSummary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <!-- データサマリーがここに表示されます -->
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="submitDataDirectly()">📤 データを送信</button>
        </div>
    </div>

    <!-- 家族追加モーダル -->
    <div id="familyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="familyModalTitle">家族追加</h3>
                <button class="close-btn" onclick="closeFamilyModal()">&times;</button>
            </div>
            <form id="familyForm">
                <input type="hidden" id="familyEmployeeId">
                <input type="hidden" id="familyType">
                <input type="hidden" id="familyId">
                
                <div class="row">
                    <div class="form-group">
                        <label for="familyName">氏名 *</label>
                        <input type="text" id="familyName" required>
                    </div>
                    <div class="form-group">
                        <label for="familyGender">性別</label>
                        <select id="familyGender">
                            <option value="">選択してください</option>
                            <option value="男性">男性</option>
                            <option value="女性">女性</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="familyBirthDate">生年月日</label>
                    <input type="date" id="familyBirthDate">
                </div>

                <div class="form-group">
                    <label for="familyPostalCode">郵便番号</label>
                    <input type="text" id="familyPostalCode" placeholder="例: 123-4567">
                </div>

                <div class="form-group">
                    <label for="familyAddress">住所</label>
                    <textarea id="familyAddress" rows="3" placeholder="都道府県市区町村番地"></textarea>
                </div>

                <button type="submit" class="btn">保存</button>
                <button type="button" class="btn btn-secondary" onclick="closeFamilyModal()">キャンセル</button>
            </form>
        </div>
    </div>

    <script>
        // グローバル変数
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let salaryItems = JSON.parse(localStorage.getItem('salaryItems')) || [
            { id: 1, name: '残業時間', type: 'attendance', description: '残業時間（時間）' },
            { id: 2, name: '基本給', type: 'income', description: '基本給金' },
            { id: 3, name: '通勤費', type: 'income', description: '通勤手当' }
        ];
        let salaryData = JSON.parse(localStorage.getItem('salaryData')) || [];
        let currentCSV = '';

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // デフォルト項目を保存
            if (JSON.parse(localStorage.getItem('salaryItems')) === null) {
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
            }
            
            // 保存されたメールアドレスを復元
            const savedEmail = localStorage.getItem('savedEmailAddress');
            if (savedEmail) {
                document.getElementById('emailTo').value = savedEmail;
            }
            
            // メールアドレス入力フィールドに変更イベントを追加
            document.getElementById('emailTo').addEventListener('input', function() {
                const emailValue = this.value.trim();
                if (emailValue) {
                    localStorage.setItem('savedEmailAddress', emailValue);
                }
            });
            
            displayEmployees();
            displayItems();
            displaySalaryData();
            updateEmployeeSelect();
            updateSalaryInputs();
            updateSummary();
            
            // 現在の月をデフォルトに設定
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salaryMonth').value = currentMonth;
            document.getElementById('csvMonth').value = currentMonth;
            document.getElementById('emailMonth').value = currentMonth;
        });

        // タブ切り替え
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'employees') {
                displayEmployees();
            } else if (tabName === 'items') {
                displayItems();
            } else if (tabName === 'salary') {
                updateEmployeeSelect();
                updateSalaryInputs();
            } else if (tabName === 'data') {
                displaySalaryData();
                // インポートセクションを非表示にする
                document.getElementById('importSection').style.display = 'none';
            } else if (tabName === 'generate') {
                updateSummary();
            }
        }

        // 従業員フォーム送信
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editEmployeeId').value;
            
            if (editId) {
                // 編集モード
                const employeeIndex = employees.findIndex(emp => emp.id == editId);
                if (employeeIndex >= 0) {
                    employees[employeeIndex] = {
                        ...employees[employeeIndex],
                        name: document.getElementById('empName').value,
                        employeeId: document.getElementById('empId').value,
                        gender: document.getElementById('empGender').value,
                        birthDate: document.getElementById('empBirthDate').value,
                        department: document.getElementById('empDepartment').value,
                        position: document.getElementById('empPosition').value,
                        postalCode: document.getElementById('empPostalCode').value,
                        address: document.getElementById('empAddress').value
                    };

                    localStorage.setItem('employees', JSON.stringify(employees));
                    showAlert('従業員情報を更新しました。', 'success');
                    clearEmployeeForm();
                    displayEmployees();
                    updateEmployeeSelect();
                }
            } else {
                // 新規追加モード
                const employee = {
                    id: Date.now(),
                    name: document.getElementById('empName').value,
                    employeeId: document.getElementById('empId').value,
                    gender: document.getElementById('empGender').value,
                    birthDate: document.getElementById('empBirthDate').value,
                    department: document.getElementById('empDepartment').value,
                    position: document.getElementById('empPosition').value,
                    postalCode: document.getElementById('empPostalCode').value,
                    address: document.getElementById('empAddress').value,
                    spouse: [],
                    dependents: [],
                    createdAt: new Date().toISOString()
                };

                employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(employees));

                showAlert('従業員を追加しました。', 'success');
                clearEmployeeForm();
                displayEmployees();
                updateEmployeeSelect();
            }
        });

        // 従業員編集
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            // フォームに値を設定
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('empName').value = employee.name;
            document.getElementById('empId').value = employee.employeeId;
            document.getElementById('empGender').value = employee.gender || '';
            document.getElementById('empBirthDate').value = employee.birthDate || '';
            document.getElementById('empDepartment').value = employee.department || '';
            document.getElementById('empPosition').value = employee.position || '';
            document.getElementById('empPostalCode').value = employee.postalCode || '';
            document.getElementById('empAddress').value = employee.address || '';

            // ボタンを編集モードに変更
            document.getElementById('employeeSubmitBtn').textContent = '従業員を更新';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // フォームまでスクロール
            document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
        }

        // 編集キャンセル
        function cancelEdit() {
            clearEmployeeForm();
        }

        // 家族フォーム送信
        document.getElementById('familyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const familyMember = {
                id: document.getElementById('familyId').value || Date.now(),
                name: document.getElementById('familyName').value,
                gender: document.getElementById('familyGender').value,
                birthDate: document.getElementById('familyBirthDate').value,
                postalCode: document.getElementById('familyPostalCode').value,
                address: document.getElementById('familyAddress').value
            };

            const employeeId = parseInt(document.getElementById('familyEmployeeId').value);
            const familyType = document.getElementById('familyType').value;
            const employee = employees.find(emp => emp.id === employeeId);

            if (employee) {
                if (familyType === 'spouse') {
                    const existingIndex = employee.spouse.findIndex(s => s.id == familyMember.id);
                    if (existingIndex >= 0) {
                        employee.spouse[existingIndex] = familyMember;
                    } else {
                        employee.spouse.push(familyMember);
                    }
                } else if (familyType === 'dependent') {
                    const existingIndex = employee.dependents.findIndex(d => d.id == familyMember.id);
                    if (existingIndex >= 0) {
                        employee.dependents[existingIndex] = familyMember;
                    } else {
                        employee.dependents.push(familyMember);
                    }
                }

                localStorage.setItem('employees', JSON.stringify(employees));
                displayEmployees();
                showAlert('家族情報を保存しました。', 'success');
                closeFamilyModal();
            }
        });

        // 項目フォーム送信
        document.getElementById('itemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                name: document.getElementById('itemName').value,
                type: document.getElementById('itemType').value,
                description: document.getElementById('itemDescription').value,
                createdAt: new Date().toISOString()
            };

            salaryItems.push(item);
            localStorage.setItem('salaryItems', JSON.stringify(salaryItems));

            showAlert('給料項目を追加しました。', 'success');
            clearItemForm();
            displayItems();
            updateSalaryInputs();
        });

        // 給料フォーム送信
        document.getElementById('salaryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedEmployeeId = document.getElementById('selectedEmployee').value;
            const month = document.getElementById('salaryMonth').value;
            
            if (!selectedEmployeeId) {
                showAlert('従業員を選択してください。', 'error');
                return;
            }

            const employee = employees.find(emp => emp.id == selectedEmployeeId);
            if (!employee) {
                showAlert('選択された従業員が見つかりません。', 'error');
                return;
            }

            // 給料データを収集
            const salaryInputs = document.querySelectorAll('#salaryInputs input[type="number"]');
            const salaryDataItem = {
                id: Date.now(),
                employeeId: selectedEmployeeId,
                employeeName: employee.name,
                employeeEmployeeId: employee.employeeId,
                month: month,
                items: {},
                totalIncome: 0,
                totalDeduction: 0,
                netSalary: 0,
                createdAt: new Date().toISOString()
            };

            salaryItems.forEach(item => {
                const input = document.getElementById(`salary_${item.id}`);
                if (input) {
                    const value = parseFloat(input.value) || 0;
                    salaryDataItem.items[item.id] = value;
                    
                    if (item.type === 'income') {
                        salaryDataItem.totalIncome += value;
                    } else if (item.type === 'deduction') {
                        salaryDataItem.totalDeduction += value;
                    }
                    // 勤怠項目は計算に含めない
                }
            });

            salaryDataItem.netSalary = salaryDataItem.totalIncome - salaryDataItem.totalDeduction;

            // 既存データを更新または新規追加
            const existingIndex = salaryData.findIndex(data => 
                data.employeeId == selectedEmployeeId && data.month === month
            );

            if (existingIndex >= 0) {
                salaryData[existingIndex] = salaryDataItem;
            } else {
                salaryData.push(salaryDataItem);
            }

            localStorage.setItem('salaryData', JSON.stringify(salaryData));

            // 保存成功メッセージをボタン近くに表示
            const submitBtn = document.querySelector('#salaryForm button[type="submit"]');
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success';
            successMessage.textContent = '給料データを保存しました。';
            successMessage.style.marginTop = '10px';
            successMessage.style.marginBottom = '10px';
            
            // 既存のメッセージがあれば削除
            const existingMessage = submitBtn.parentNode.querySelector('.alert-success');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // ボタンの後にメッセージを挿入
            submitBtn.parentNode.insertBefore(successMessage, submitBtn.nextSibling);
            
            // 3秒後にメッセージを削除
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.remove();
                }
            }, 3000);
            
            displaySalaryData();
        });

        // 給料データ読み込み
        function loadSalaryData() {
            const selectedEmployeeId = document.getElementById('selectedEmployee').value;
            const month = document.getElementById('salaryMonth').value;
            
            if (!selectedEmployeeId || !month) {
                return;
            }

            const existingData = salaryData.find(data => 
                data.employeeId == selectedEmployeeId && data.month === month
            );

            if (existingData) {
                // 保存されているデータを入力フィールドに設定
                salaryItems.forEach(item => {
                    const input = document.getElementById(`salary_${item.id}`);
                    if (input) {
                        input.value = existingData.items[item.id] || '';
                    }
                });
                showAlert('保存されているデータを読み込みました。', 'success');
            } else {
                // 新規データの場合はフィールドをクリア
                salaryItems.forEach(item => {
                    const input = document.getElementById(`salary_${item.id}`);
                    if (input) {
                        input.value = '';
                    }
                });
            }
        }

        // フォームクリア関数
        function clearEmployeeForm() {
            document.getElementById('employeeForm').reset();
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('employeeSubmitBtn').textContent = '従業員を追加';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function clearItemForm() {
            document.getElementById('itemForm').reset();
        }

        function clearSalaryForm() {
            document.getElementById('salaryForm').reset();
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salaryMonth').value = currentMonth;
            
            // 入力フィールドをクリア
            const inputs = document.querySelectorAll('#salaryInputs input[type="number"]');
            inputs.forEach(input => input.value = '');
        }

        // 従業員一覧表示
        function displayEmployees() {
            const listContainer = document.getElementById('employeeList');
            
            if (employees.length === 0) {
                listContainer.innerHTML = '<p>従業員データがありません。</p>';
                return;
            }

            listContainer.innerHTML = employees.map(emp => {
                let html = `
                    <div class="employee-item">
                        <div class="employee-header">
                            <div class="employee-info">
                                <div class="employee-name">${emp.name} (${emp.employeeId})</div>
                                <div class="employee-details">
                                    ${emp.gender} | ${emp.birthDate} | ${emp.department} | ${emp.position}<br>
                                    〒${emp.postalCode} | ${emp.address}
                                </div>
                            </div>
                            <div class="employee-actions">
                                <button class="btn btn-small btn-secondary" onclick="editEmployee(${emp.id})">編集</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEmployee(${emp.id})">削除</button>
                            </div>
                        </div>
                `;

                // 配偶者セクション
                if (emp.spouse && emp.spouse.length > 0) {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">配偶者</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'spouse')">追加</button>
                            </div>
                            <div class="family-list">
                    `;
                    emp.spouse.forEach(spouse => {
                        html += `
                            <div class="family-item">
                                <div class="family-info">
                                    <div class="family-name">${spouse.name}</div>
                                    <div class="family-details">
                                        ${spouse.gender} | ${spouse.birthDate} | 〒${spouse.postalCode} | ${spouse.address}
                                    </div>
                                </div>
                                <div class="family-actions">
                                    <button class="btn btn-xs btn-secondary" onclick="editFamily(${emp.id}, 'spouse', ${spouse.id})">編集</button>
                                    <button class="btn btn-xs btn-danger" onclick="deleteFamily(${emp.id}, 'spouse', ${spouse.id})">削除</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                } else {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">配偶者</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'spouse')">追加</button>
                            </div>
                        </div>
                    `;
                }

                // 扶養親族セクション
                if (emp.dependents && emp.dependents.length > 0) {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">扶養親族</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'dependent')">追加</button>
                            </div>
                            <div class="family-list">
                    `;
                    emp.dependents.forEach(dependent => {
                        html += `
                            <div class="family-item">
                                <div class="family-info">
                                    <div class="family-name">${dependent.name}</div>
                                    <div class="family-details">
                                        ${dependent.gender} | ${dependent.birthDate} | 〒${dependent.postalCode} | ${dependent.address}
                                    </div>
                                </div>
                                <div class="family-actions">
                                    <button class="btn btn-xs btn-secondary" onclick="editFamily(${emp.id}, 'dependent', ${dependent.id})">編集</button>
                                    <button class="btn btn-xs btn-danger" onclick="deleteFamily(${emp.id}, 'dependent', ${dependent.id})">削除</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                } else {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">扶養親族</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'dependent')">追加</button>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                return html;
            }).join('');
        }

        // 家族追加・編集
        function addFamily(employeeId, type) {
            document.getElementById('familyModalTitle').textContent = type === 'spouse' ? '配偶者追加' : '扶養親族追加';
            document.getElementById('familyEmployeeId').value = employeeId;
            document.getElementById('familyType').value = type;
            document.getElementById('familyId').value = '';
            document.getElementById('familyForm').reset();
            document.getElementById('familyModal').style.display = 'block';
        }

        function editFamily(employeeId, type, familyId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const familyList = type === 'spouse' ? employee.spouse : employee.dependents;
            const family = familyList.find(f => f.id == familyId);
            if (!family) return;

            document.getElementById('familyModalTitle').textContent = type === 'spouse' ? '配偶者編集' : '扶養親族編集';
            document.getElementById('familyEmployeeId').value = employeeId;
            document.getElementById('familyType').value = type;
            document.getElementById('familyId').value = familyId;
            document.getElementById('familyName').value = family.name;
            document.getElementById('familyGender').value = family.gender;
            document.getElementById('familyBirthDate').value = family.birthDate;
            document.getElementById('familyPostalCode').value = family.postalCode;
            document.getElementById('familyAddress').value = family.address;
            document.getElementById('familyModal').style.display = 'block';
        }

        function deleteFamily(employeeId, type, familyId) {
            if (!confirm('この家族情報を削除しますか？')) return;

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            if (type === 'spouse') {
                employee.spouse = employee.spouse.filter(s => s.id != familyId);
            } else {
                employee.dependents = employee.dependents.filter(d => d.id != familyId);
            }

            localStorage.setItem('employees', JSON.stringify(employees));
            displayEmployees();
            showAlert('家族情報を削除しました。', 'success');
        }

        function closeFamilyModal() {
            document.getElementById('familyModal').style.display = 'none';
        }

        // 項目一覧表示
        function displayItems() {
            const listContainer = document.getElementById('itemList');
            
            if (salaryItems.length === 0) {
                listContainer.innerHTML = '<p>給料項目がありません。</p>';
                return;
            }

            const typeLabels = {
                'attendance': '勤怠項目',
                'income': '収入項目',
                'deduction': '控除項目'
            };

            const typeClasses = {
                'attendance': 'type-attendance',
                'income': 'type-income',
                'deduction': 'type-deduction'
            };

            listContainer.innerHTML = salaryItems.map(item => `
                <div class="salary-item">
                    <div class="item-info">
                        <div class="item-name">
                            ${item.name}
                            <span class="type-badge ${typeClasses[item.type]}">${typeLabels[item.type]}</span>
                        </div>
                        <div class="item-details">
                            ${item.description}
                        </div>
                    </div>
                                         <div class="item-actions">
                         <button class="btn btn-small btn-danger" onclick="deleteItem(${item.id})">削除</button>
                     </div>
                </div>
            `).join('');
        }

        // 給料データ一覧表示
        function displaySalaryData() {
            const listContainer = document.getElementById('salaryDataList');
            
            if (salaryData.length === 0) {
                listContainer.innerHTML = '<p>給料データがありません。</p>';
                return;
            }

            listContainer.innerHTML = salaryData.map(data => `
                <div class="salary-data-item">
                    <div class="salary-data-info">
                        <div class="salary-data-name">${data.employeeName} (${data.employeeEmployeeId})</div>
                        <div class="salary-data-details">
                            ${data.month} | 総収入: ¥${data.totalIncome.toLocaleString()} | 
                            総控除: ¥${data.totalDeduction.toLocaleString()} | 
                            手取り: ¥${data.netSalary.toLocaleString()}
                        </div>
                    </div>
                                         <div class="salary-data-actions">
                         <button class="btn btn-small btn-danger" onclick="deleteSalaryData(${data.id})">削除</button>
                     </div>
                </div>
            `).join('');
        }

        // 従業員選択コンボボックス更新
        function updateEmployeeSelect() {
            const select = document.getElementById('selectedEmployee');
            select.innerHTML = '<option value="">従業員を選択してください</option>';
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} (${emp.employeeId})`;
                select.appendChild(option);
            });
        }

        // 給料入力フィールド更新
        function updateSalaryInputs() {
            const container = document.getElementById('salaryInputs');
            
            if (salaryItems.length === 0) {
                container.innerHTML = '<h3>給料項目</h3><p>項目管理タブで項目を追加してください。</p>';
                return;
            }

            let html = '<h3>給料項目</h3>';
            
            // 項目をタイプ別に分類
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');

            // 勤怠項目
            if (attendanceItems.length > 0) {
                html += '<div class="section-header">📊 勤怠項目</div>';
                attendanceItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            // 収入項目
            if (incomeItems.length > 0) {
                html += '<div class="section-header">💰 収入項目</div>';
                incomeItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            // 控除項目
            if (deductionItems.length > 0) {
                html += '<div class="section-header">💸 控除項目</div>';
                deductionItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // 削除関数
        function deleteEmployee(id) {
            if (confirm('この従業員データを削除しますか？')) {
                employees = employees.filter(emp => emp.id !== id);
                salaryData = salaryData.filter(data => data.employeeId != id);
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displayEmployees();
                displaySalaryData();
                updateEmployeeSelect();
                showAlert('従業員データを削除しました。', 'success');
            }
        }

        function deleteItem(id) {
            if (confirm('この給料項目を削除しますか？')) {
                salaryItems = salaryItems.filter(item => item.id !== id);
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
                displayItems();
                updateSalaryInputs();
                showAlert('給料項目を削除しました。', 'success');
            }
        }

        function deleteSalaryData(id) {
            if (confirm('この給料データを削除しますか？')) {
                salaryData = salaryData.filter(data => data.id !== id);
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displaySalaryData();
                showAlert('給料データを削除しました。', 'success');
            }
        }

        // 全給料データ削除
        function deleteAllSalaryData() {
            if (confirm('全ての給料データを削除しますか？この操作は取り消せません。')) {
                salaryData = [];
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displaySalaryData();
                showAlert('全ての給料データを削除しました。', 'success');
            }
        }

        // 全データエクスポート
        function exportAllData() {
            generateBackupJSON();
        }

        // JSONバックアップ生成
        function generateBackupJSON() {
            const exportData = {
                employees: employees,
                salaryItems: salaryItems,
                salaryData: salaryData,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `給料データ_バックアップ_${new Date().toISOString().slice(0, 10)}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('全データをエクスポートしました。', 'success');
        }

        // データインポート機能
        let importDataContent = null;

        function importData() {
            document.getElementById('importSection').style.display = 'block';
            document.getElementById('importFile').value = '';
            document.getElementById('confirmImportBtn').style.display = 'none';
            importDataContent = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // データ形式の検証
                    if (!data.employees || !data.salaryItems || !data.salaryData) {
                        showAlert('無効なJSONファイルです。正しい形式のファイルを選択してください。', 'error');
                        return;
                    }

                    importDataContent = data;
                    document.getElementById('confirmImportBtn').style.display = 'inline-block';
                    
                    // インポート内容のプレビュー表示
                    const preview = `
                        インポート内容:
                        - 従業員: ${data.employees.length}件
                        - 給料項目: ${data.salaryItems.length}件
                        - 給料データ: ${data.salaryData.length}件
                        - エクスポート日時: ${data.exportedAt ? new Date(data.exportedAt).toLocaleString() : '不明'}
                    `;
                    showAlert(preview, 'success');
                    
                } catch (error) {
                    showAlert('JSONファイルの読み込みに失敗しました。正しい形式のファイルを選択してください。', 'error');
                }
            };
            reader.readAsText(file);
        }

        function confirmImport() {
            if (!importDataContent) {
                showAlert('インポートするデータがありません。', 'error');
                return;
            }

            if (confirm('現在のデータを上書きしますか？この操作は取り消せません。')) {
                // データを上書き
                employees = importDataContent.employees || [];
                salaryItems = importDataContent.salaryItems || [];
                salaryData = importDataContent.salaryData || [];

                // ローカルストレージに保存
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
                localStorage.setItem('salaryData', JSON.stringify(salaryData));

                // UIを更新
                displayEmployees();
                displayItems();
                displaySalaryData();
                updateEmployeeSelect();
                updateSalaryInputs();
                updateSummary();

                showAlert('データのインポートが完了しました。', 'success');
                cancelImport();
            }
        }

        function cancelImport() {
            document.getElementById('importSection').style.display = 'none';
            document.getElementById('importFile').value = '';
            document.getElementById('confirmImportBtn').style.display = 'none';
            importDataContent = null;
        }



        // サマリー更新
        function updateSummary() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                return;
            }

            const totalEmployees = new Set(filteredData.map(data => data.employeeId)).size;
            const totalSalary = filteredData.reduce((sum, data) => sum + data.netSalary, 0);
            const avgSalary = totalSalary / filteredData.length;

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalSalary').textContent = `¥${totalSalary.toLocaleString()}`;
            document.getElementById('avgSalary').textContent = `¥${Math.round(avgSalary).toLocaleString()}`;
            document.getElementById('summaryCard').style.display = 'block';
        }

        // CSV生成
        function generateCSV() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                showAlert('指定された月の給料データがありません。', 'error');
                return;
            }

            // 項目をタイプ別に並び替え
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['従業員ID', '氏名'];
            
            // 項目ヘッダーを追加（並び順通り）
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [
                    data.employeeEmployeeId,
                    data.employeeName
                ];

                // 各項目の値を追加（並び順通り）
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });

                return row;
            });

            const csv = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            currentCSV = csv;

            // ファイルダウンロード
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const fileName = selectedMonth ? 
                `給料データ_${selectedMonth}.csv` : 
                `給料データ_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('CSVファイルをダウンロードしました。', 'success');
        }

        // CSVプレビュー
        function previewCSV() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                showAlert('指定された月の給料データがありません。', 'error');
                return;
            }

            // 項目をタイプ別に並び替え
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['従業員ID', '氏名', '総収入', '総控除', '手取り給料'];
            
            // 項目ヘッダーを追加（並び順通り）
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [
                    data.employeeEmployeeId,
                    data.employeeName,
                    data.totalIncome,
                    data.totalDeduction,
                    data.netSalary
                ];

                // 各項目の値を追加（並び順通り）
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });

                return row;
            });

            // テーブル表示
            const table = document.getElementById('csvTable');
            let tableHTML = '<thead><tr>';
            
            // ヘッダー行
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // データ行
            csvData.forEach(row => {
                tableHTML += '<tr>';
                row.forEach((cell, index) => {
                    if (index >= 2 && index <= 4) {
                        // 金額列は通貨形式で表示
                        tableHTML += `<td>¥${parseFloat(cell).toLocaleString()}</td>`;
                    } else {
                        tableHTML += `<td>${cell}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;

            document.getElementById('csvPreview').style.display = 'block';
            showAlert('CSVプレビューを表示しました。', 'success');
        }

        // メール送信用ファイル作成
        function createEmailFiles() {
            const selectedMonth = document.getElementById('emailMonth').value;
            
            if (!selectedMonth) {
                showAlert('対象月を選択してください。', 'error');
                return;
            }

            let filteredData = salaryData.filter(data => data.month === selectedMonth);
            
            if (filteredData.length === 0) {
                showAlert('指定された月の給料データがありません。', 'error');
                return;
            }

            // 1. 給料データCSVを作成
            const salaryCSV = createSalaryCSV(filteredData);
            
            // 2. 従業員データCSVを作成
            const employeeCSV = createEmployeeCSV();
            
            // 3. 配偶者データCSVを作成
            const spouseCSV = createSpouseCSV();
            
            // 4. 扶養親族データCSVを作成
            const dependentCSV = createDependentCSV();
            
            // 5. 全データJSONを作成
            const allDataJSON = createAllDataJSON(filteredData, selectedMonth);

            // ZIPファイルを作成
            createZIPFile(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth);
        }

        // 給料データCSV作成
        function createSalaryCSV(filteredData) {
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['従業員ID', '氏名'];
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [data.employeeEmployeeId, data.employeeName];
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });
                return row;
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        // 従業員データCSV作成
        function createEmployeeCSV() {
            const headers = ['従業員ID', '氏名', '性別', '生年月日', '部署', '役職', '郵便番号', '住所'];
            const csvData = employees.map(emp => [
                emp.employeeId,
                emp.name,
                emp.gender,
                emp.birthDate,
                emp.department,
                emp.position,
                emp.postalCode,
                emp.address
            ]);

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // 配偶者データCSV作成
        function createSpouseCSV() {
            const headers = ['従業員ID', '従業員氏名', '配偶者氏名', '性別', '生年月日', '郵便番号', '住所'];
            const csvData = [];
            
            employees.forEach(emp => {
                if (emp.spouse && emp.spouse.length > 0) {
                    emp.spouse.forEach(spouse => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            spouse.name,
                            spouse.gender,
                            spouse.birthDate,
                            spouse.postalCode,
                            spouse.address
                        ]);
                    });
                }
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // 扶養親族データCSV作成
        function createDependentCSV() {
            const headers = ['従業員ID', '従業員氏名', '扶養親族氏名', '性別', '生年月日', '郵便番号', '住所'];
            const csvData = [];
            
            employees.forEach(emp => {
                if (emp.dependents && emp.dependents.length > 0) {
                    emp.dependents.forEach(dependent => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            dependent.name,
                            dependent.gender,
                            dependent.birthDate,
                            dependent.postalCode,
                            dependent.address
                        ]);
                    });
                }
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // 全データJSON作成
        function createAllDataJSON(filteredData, selectedMonth) {
            return JSON.stringify({
                employees: employees,
                salaryItems: salaryItems,
                salaryData: filteredData,
                selectedMonth: selectedMonth,
                exportedAt: new Date().toISOString()
            }, null, 2);
        }

        // ZIPファイル作成
        function createZIPFile(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth) {
            // JSZipライブラリを使用してZIPファイルを作成
            if (typeof JSZip === 'undefined') {
                // JSZipが利用できない場合は個別ファイルをダウンロード
                downloadIndividualFiles(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth);
                return;
            }

            const zip = new JSZip();
            
            // ファイルをZIPに追加
            zip.file(`給料データ_${selectedMonth}.csv`, '\uFEFF' + salaryCSV);
            zip.file(`従業員データ_${selectedMonth}.csv`, '\uFEFF' + employeeCSV);
            zip.file(`配偶者データ_${selectedMonth}.csv`, '\uFEFF' + spouseCSV);
            zip.file(`扶養親族データ_${selectedMonth}.csv`, '\uFEFF' + dependentCSV);
            zip.file(`全データ_${selectedMonth}.json`, allDataJSON);

            // ZIPファイルをダウンロード
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const link = document.createElement('a');
                const url = URL.createObjectURL(content);
                link.setAttribute('href', url);
                link.setAttribute('download', `給料データ_${selectedMonth}_${new Date().toISOString().slice(0, 10)}.zip`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('ZIPファイルを作成しました。次に「2. メールソフト起動」ボタンをクリックしてください。', 'success');
            });
        }

        // 個別ファイルダウンロード（JSZipが利用できない場合）
        function downloadIndividualFiles(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth) {
            const files = [
                { content: '\uFEFF' + salaryCSV, filename: `給料データ_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + employeeCSV, filename: `従業員データ_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + spouseCSV, filename: `配偶者データ_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + dependentCSV, filename: `扶養親族データ_${selectedMonth}.csv`, type: 'text/csv' },
                { content: allDataJSON, filename: `全データ_${selectedMonth}.json`, type: 'application/json' }
            ];

            files.forEach(file => {
                const blob = new Blob([file.content], { type: file.type });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', file.filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            showAlert('5つのファイルをダウンロードしました。次に「2. メールソフト起動」ボタンをクリックしてください。', 'success');
        }

        // メールクライアント起動
        function launchEmailClient() {
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const selectedMonth = document.getElementById('emailMonth').value;

            if (!to) {
                showAlert('送信先メールアドレスを入力してください。', 'error');
                return;
            }

            if (!selectedMonth) {
                showAlert('対象月を選択してください。', 'error');
                return;
            }

            // メールアドレスをローカルストレージに保存
            localStorage.setItem('savedEmailAddress', to);

            // メール本文を作成
            const body = `給料データをお送りいたします。

添付ファイル：
1. 給料データ_${selectedMonth}.csv - 対象月の給料データ
2. 従業員データ_${selectedMonth}.csv - 従業員情報
3. 配偶者データ_${selectedMonth}.csv - 配偶者情報
4. 扶養親族データ_${selectedMonth}.csv - 扶養親族情報
5. 全データ_${selectedMonth}.json - 全データ（バックアップ用）

対象月: ${selectedMonth}
データ件数: ${salaryData.filter(data => data.month === selectedMonth).length}件
従業員数: ${employees.length}名
項目数: ${salaryItems.length}個

ご確認をお願いいたします。`;

            // メールクライアントを起動
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            showAlert('メールクライアントを起動しました。手動でファイルを添付してください。', 'success');
        }



        // 従業員データCSV生成
        function generateEmployeeCSV() {
            const headers = ['従業員ID', '氏名', '性別', '生年月日', '部署', '役職', '郵便番号', '住所'];
            
            const csvData = employees.map(emp => [
                emp.employeeId,
                emp.name,
                emp.gender,
                emp.birthDate,
                emp.department,
                emp.position,
                emp.postalCode,
                emp.address
            ]);

            const csv = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');

            // ファイルダウンロード
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `従業員データ_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 配偶者データCSV生成
        function generateSpouseCSV() {
            const headers = ['従業員ID', '従業員氏名', '配偶者氏名', '性別', '生年月日', '郵便番号', '住所'];
            
            const csvData = [];
            employees.forEach(emp => {
                if (emp.spouse && emp.spouse.length > 0) {
                    emp.spouse.forEach(spouse => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            spouse.name,
                            spouse.gender,
                            spouse.birthDate,
                            spouse.postalCode,
                            spouse.address
                        ]);
                    });
                }
            });

            if (csvData.length > 0) {
                const csv = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                    .join('\n');

                // ファイルダウンロード
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `配偶者データ_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 扶養親族データCSV生成
        function generateDependentCSV() {
            const headers = ['従業員ID', '従業員氏名', '扶養親族氏名', '性別', '生年月日', '郵便番号', '住所'];
            
            const csvData = [];
            employees.forEach(emp => {
                if (emp.dependents && emp.dependents.length > 0) {
                    emp.dependents.forEach(dependent => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            dependent.name,
                            dependent.gender,
                            dependent.birthDate,
                            dependent.postalCode,
                            dependent.address
                        ]);
                    });
                }
            });

            if (csvData.length > 0) {
                const csv = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                    .join('\n');

                // ファイルダウンロード
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `扶養親族データ_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // アラート表示
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 直接送信モーダル表示
        function showDirectSubmitModal() {
            // URLパラメータからUserIdを取得
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            if (!userId) {
                showAlert('URLパラメータにuserIdが指定されていません。', 'error');
                return;
            }
            
            // データサマリーを表示
            const summary = `
                <strong>📊 送信データサマリー</strong><br>
                • ユーザーID: ${userId}<br>
                • 従業員数: ${employees.length}名<br>
                • 給料データ: ${salaryData.length}件<br>
                • 給料項目: ${salaryItems.length}個<br>
                • 最終更新: ${new Date().toLocaleString()}
            `;
            document.getElementById('directSubmitDataSummary').innerHTML = summary;
            
            // モーダルを表示
            document.getElementById('directSubmitModal').style.display = 'block';
        }

        // 直接送信モーダルを閉じる
        function closeDirectSubmitModal() {
            document.getElementById('directSubmitModal').style.display = 'none';
            document.getElementById('directSubmitPassword').value = '';
        }

        // データを直接送信
        function submitDataDirectly() {
            const password = document.getElementById('directSubmitPassword').value;
            
            if (!password) {
                showAlert('パスワードを入力してください。', 'error');
                return;
            }
            
            // URLパラメータからUserIdを取得
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            if (!userId) {
                showAlert('URLパラメータにuserIdが指定されていません。', 'error');
                return;
            }
            
            // 本番用GASのURL
            const webhookUrl = 'https://script.google.com/macros/s/AKfycbwl_jL4zt1PlHsGpz0SauH1PKRBotSOKEP98uAHu3sSzuvmLY0fJJEe2qO2UZIzKXUD/exec';
            
            // データを準備（ファイル作成と同じ形式）
            const data = {
                employees: employees,
                salaryItems: salaryItems,
                salaryData: salaryData,
                auth: {
                    userId: userId,
                    password: password,
                    applicationName: '給料管理システム'
                },
                metadata: {
                    submittedAt: new Date().toISOString()
                }
            };
            
            // 送信実行
            submitToGoogleAppsScript(webhookUrl, data);
        }

        // Google Apps Script対応の送信関数
        function submitToGoogleAppsScript(webhookUrl, data) {
            try {
                console.log('データ送信開始:', webhookUrl);
                console.log('送信データ:', data);
                
                // データをBase64エンコードして送信（特殊文字対応）
                const jsonString = JSON.stringify(data);
                const encodedData = btoa(unescape(encodeURIComponent(jsonString)));
                
                // フォーム送信方式を使用（CORS問題を回避）
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = webhookUrl;
                form.target = 'hiddenFrame'; // 非表示フレームで送信
                form.style.display = 'none';
                
                // 非表示のiframeを作成してレスポンスを受信
                let hiddenFrame = document.getElementById('hiddenFrame');
                if (!hiddenFrame) {
                    hiddenFrame = document.createElement('iframe');
                    hiddenFrame.id = 'hiddenFrame';
                    hiddenFrame.name = 'hiddenFrame';
                    hiddenFrame.style.display = 'none';
                    document.body.appendChild(hiddenFrame);
                }
                
                // データをフォームフィールドとして追加
                const dataField = document.createElement('input');
                dataField.type = 'hidden';
                dataField.name = 'postData';
                dataField.value = encodedData;
                form.appendChild(dataField);
                
                // フォームをDOMに追加して送信
                document.body.appendChild(form);
                form.submit();
                
                // 送信後の処理
                showAlert('データの送信を開始しました。管理者にメール通知が送信されます。', 'success');
                closeDirectSubmitModal();
                
                // フォームを削除
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('データ送信エラー:', error);
                showAlert('データの送信に失敗しました。管理者にご連絡ください。', 'error');
            }
        }
    </script>
</body>
</html>