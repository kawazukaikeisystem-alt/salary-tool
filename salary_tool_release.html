<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .tab.active {
            background: #4facfe;
            color: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active:hover {
            background: #4facfe;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .employee-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .employee-item {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .employee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #333;
            font-size: 1.2em;
        }

        .employee-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .employee-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .family-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .family-title {
            font-weight: 600;
            color: #333;
        }

        .family-list {
            display: grid;
            gap: 10px;
        }

        .family-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #56ab2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .family-info {
            flex: 1;
        }

        .family-name {
            font-weight: 600;
            color: #333;
        }

        .family-details {
            color: #666;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .family-actions {
            display: flex;
            gap: 5px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 0.8em;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .salary-items {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #56ab2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .item-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .salary-inputs {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .salary-input-group {
            display: flex;
            flex-direction: column;
        }

        .salary-input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .salary-input-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .salary-input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .section-header {
            background: #e9ecef;
            padding: 10px 15px;
            margin: 15px 0 10px 0;
            border-radius: 6px;
            font-weight: 600;
            color: #495057;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .salary-data-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .salary-data-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f093fb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .salary-data-info {
            flex: 1;
        }

        .salary-data-name {
            font-weight: 600;
            color: #333;
        }

        .salary-data-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .salary-data-actions {
            display: flex;
            gap: 10px;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .type-attendance {
            background: #fff3cd;
            color: #856404;
        }

        .type-income {
            background: #d4edda;
            color: #155724;
        }

        .type-deduction {
            background: #f8d7da;
            color: #721c24;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .row, .row-3, .salary-input-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-radius: 8px;
                margin-bottom: 5px;
            }

            .data-table {
                font-size: 0.9em;
            }

            .data-table th, .data-table td {
                padding: 8px;
            }

            .employee-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .family-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
            <p>å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ãƒ»CSVç”Ÿæˆãƒ»ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ç°¡å˜ã«</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab" onclick="showTab('employees')">ğŸ‘¥ å¾“æ¥­å“¡ç®¡ç†</button>
                <button class="tab" onclick="showTab('items')">ğŸ“‹ é …ç›®ç®¡ç†</button>
                <button class="tab active" onclick="showTab('salary')">ğŸ’° çµ¦æ–™å…¥åŠ›</button>
                <button class="tab" onclick="showTab('data')">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</button>
                <button class="tab" onclick="showTab('generate')">ğŸ“ˆ CSVç”Ÿæˆ</button>
                <button class="tab" onclick="showTab('email')">ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡</button>
            </div>

            <!-- å¾“æ¥­å“¡ç®¡ç†ã‚¿ãƒ– -->
            <div id="employees" class="tab-content">
                <h2>å¾“æ¥­å“¡ç®¡ç†</h2>
                <form id="employeeForm">
                    <input type="hidden" id="editEmployeeId">
                    <div class="row">
                        <div class="form-group">
                            <label for="empName">æ°å *</label>
                            <input type="text" id="empName" required>
                        </div>
                        <div class="form-group">
                            <label for="empId">å¾“æ¥­å“¡ID *</label>
                            <input type="text" id="empId" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="empGender">æ€§åˆ¥</label>
                            <select id="empGender">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="empBirthDate">ç”Ÿå¹´æœˆæ—¥</label>
                            <input type="date" id="empBirthDate">
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group">
                            <label for="empDepartment">éƒ¨ç½²</label>
                            <select id="empDepartment">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="å–¶æ¥­éƒ¨">å–¶æ¥­éƒ¨</option>
                                <option value="é–‹ç™ºéƒ¨">é–‹ç™ºéƒ¨</option>
                                <option value="äººäº‹éƒ¨">äººäº‹éƒ¨</option>
                                <option value="çµŒç†éƒ¨">çµŒç†éƒ¨</option>
                                <option value="ç·å‹™éƒ¨">ç·å‹™éƒ¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="empPosition">å½¹è·</label>
                            <select id="empPosition">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ä¸€èˆ¬ç¤¾å“¡">ä¸€èˆ¬ç¤¾å“¡</option>
                                <option value="ä¸»ä»»">ä¸»ä»»</option>
                                <option value="èª²é•·">èª²é•·</option>
                                <option value="éƒ¨é•·">éƒ¨é•·</option>
                                <option value="å–ç· å½¹">å–ç· å½¹</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="empPostalCode">éƒµä¾¿ç•ªå·</label>
                        <input type="text" id="empPostalCode" placeholder="ä¾‹: 123-4567">
                    </div>

                    <div class="form-group">
                        <label for="empAddress">ä½æ‰€</label>
                        <textarea id="empAddress" rows="3" placeholder="éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘ç•ªåœ°"></textarea>
                    </div>

                    <button type="submit" class="btn" id="employeeSubmitBtn">å¾“æ¥­å“¡ã‚’è¿½åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="clearEmployeeForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
                    <button type="button" class="btn btn-warning" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </form>

                <div id="employeeList" class="employee-list">
                    <p>å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

            <!-- é …ç›®ç®¡ç†ã‚¿ãƒ– -->
            <div id="items" class="tab-content">
                <h2>çµ¦æ–™é …ç›®ç®¡ç†</h2>
                <form id="itemForm">
                    <div class="row">
                        <div class="form-group">
                            <label for="itemName">é …ç›®å *</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemType">é …ç›®ã‚¿ã‚¤ãƒ— *</label>
                            <select id="itemType" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="attendance">å‹¤æ€ é …ç›®</option>
                                <option value="income">åå…¥é …ç›®</option>
                                <option value="deduction">æ§é™¤é …ç›®</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="itemDescription">èª¬æ˜</label>
                        <textarea id="itemDescription" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success">é …ç›®ã‚’è¿½åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="clearItemForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
                </form>

                <div id="itemList" class="salary-items">
                    <p>çµ¦æ–™é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

            <!-- çµ¦æ–™å…¥åŠ›ã‚¿ãƒ– -->
            <div id="salary" class="tab-content active">
                <h2>çµ¦æ–™ãƒ‡ãƒ¼ã‚¿å…¥åŠ›</h2>
                <form id="salaryForm">
                    <div class="row">
                        <div class="form-group">
                            <label for="selectedEmployee">å¾“æ¥­å“¡é¸æŠ *</label>
                            <select id="selectedEmployee" required onchange="loadSalaryData()">
                                <option value="">å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="salaryMonth">å¯¾è±¡æœˆ *</label>
                            <input type="month" id="salaryMonth" required onchange="loadSalaryData()">
                        </div>
                    </div>

                    <div id="salaryInputs" class="salary-inputs">
                        <h3>çµ¦æ–™é …ç›®</h3>
                        <p>é …ç›®ç®¡ç†ã‚¿ãƒ–ã§é …ç›®ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>

                    <button type="submit" class="btn">çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="clearSalaryForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
                </form>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¿ãƒ– -->
            <div id="data" class="tab-content">
                <h2>çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div class="row">
                    <div class="form-group">
                        <button class="btn btn-danger" onclick="deleteAllSalaryData()">å…¨çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                        <button class="btn btn-warning" onclick="exportAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-success" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                    </div>
                </div>

                <div class="form-group" style="display: none;" id="importSection">
                    <label for="importFile">JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                    <input type="file" id="importFile" accept=".json" onchange="handleFileSelect(event)">
                    <button class="btn btn-secondary" onclick="confirmImport()" id="confirmImportBtn" style="display: none;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                    <button class="btn btn-danger" onclick="cancelImport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>

                <div id="salaryDataList" class="salary-data-list">
                    <p>çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
            </div>

            <!-- CSVç”Ÿæˆã‚¿ãƒ– -->
            <div id="generate" class="tab-content">
                <h2>CSVãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ</h2>
                <div class="row">
                    <div class="form-group">
                        <label for="csvMonth">å¯¾è±¡æœˆé¸æŠ</label>
                        <input type="month" id="csvMonth" onchange="updateSummary()">
                    </div>
                </div>
                
                <div id="summaryCard" class="summary-card" style="display: none;">
                    <h3>çµ¦æ–™ã‚µãƒãƒªãƒ¼</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value" id="totalEmployees">0</div>
                            <div class="summary-label">å¾“æ¥­å“¡æ•°</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalSalary">Â¥0</div>
                            <div class="summary-label">ç·çµ¦æ–™</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="avgSalary">Â¥0</div>
                            <div class="summary-label">å¹³å‡çµ¦æ–™</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="generateCSV()">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-secondary" onclick="previewCSV()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</button>
                
                <div id="csvPreview" style="display: none;">
                    <h3>CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div style="overflow-x: auto;">
                        <table id="csvTable" class="data-table">
                            <!-- CSVãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¿ãƒ– -->
            <div id="email" class="tab-content">
                <h2>ãƒ‡ãƒ¼ã‚¿é€ä¿¡</h2>
                
                <div class="form-group">
                    <label for="emailTo">é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                    <input type="email" id="emailTo" required placeholder="example@company.com">
                </div>
                
                <div class="form-group">
                    <label for="emailSubject">ä»¶å</label>
                    <input type="text" id="emailSubject" value="çµ¦æ–™ãƒ‡ãƒ¼ã‚¿">
                </div>

                <div class="form-group">
                    <label for="emailMonth">å¯¾è±¡æœˆé¸æŠ</label>
                    <input type="month" id="emailMonth">
                </div>

                <button class="btn" onclick="createEmailFiles()">1. ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ</button>
                <button class="btn btn-secondary" onclick="launchEmailClient()">2. ãƒ¡ãƒ¼ãƒ«ã‚½ãƒ•ãƒˆèµ·å‹•</button>
                <button class="btn btn-primary" onclick="showDirectSubmitModal()">ğŸ“¤ ç›´æ¥é€ä¿¡</button>
                
                <div id="emailPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h3>é€ä¿¡å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div id="emailPreviewContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç›´æ¥é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="directSubmitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ç›´æ¥é€ä¿¡</h3>
                <button class="close-btn" onclick="closeDirectSubmitModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="directSubmitPassword">ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="directSubmitPassword" placeholder="èªè¨¼ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <small>ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã®ãŸã‚ã®èªè¨¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            </div>
            
            <div class="form-group">
                <label>ğŸ“‹ é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª</label>
                <div id="directSubmitDataSummary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <!-- ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="submitDataDirectly()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡</button>
        </div>
    </div>

    <!-- å®¶æ—è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="familyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="familyModalTitle">å®¶æ—è¿½åŠ </h3>
                <button class="close-btn" onclick="closeFamilyModal()">&times;</button>
            </div>
            <form id="familyForm">
                <input type="hidden" id="familyEmployeeId">
                <input type="hidden" id="familyType">
                <input type="hidden" id="familyId">
                
                <div class="row">
                    <div class="form-group">
                        <label for="familyName">æ°å *</label>
                        <input type="text" id="familyName" required>
                    </div>
                    <div class="form-group">
                        <label for="familyGender">æ€§åˆ¥</label>
                        <select id="familyGender">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ç”·æ€§">ç”·æ€§</option>
                            <option value="å¥³æ€§">å¥³æ€§</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="familyBirthDate">ç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" id="familyBirthDate">
                </div>

                <div class="form-group">
                    <label for="familyPostalCode">éƒµä¾¿ç•ªå·</label>
                    <input type="text" id="familyPostalCode" placeholder="ä¾‹: 123-4567">
                </div>

                <div class="form-group">
                    <label for="familyAddress">ä½æ‰€</label>
                    <textarea id="familyAddress" rows="3" placeholder="éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘ç•ªåœ°"></textarea>
                </div>

                <button type="submit" class="btn">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeFamilyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let salaryItems = JSON.parse(localStorage.getItem('salaryItems')) || [
            { id: 1, name: 'æ®‹æ¥­æ™‚é–“', type: 'attendance', description: 'æ®‹æ¥­æ™‚é–“ï¼ˆæ™‚é–“ï¼‰' },
            { id: 2, name: 'åŸºæœ¬çµ¦', type: 'income', description: 'åŸºæœ¬çµ¦é‡‘' },
            { id: 3, name: 'é€šå‹¤è²»', type: 'income', description: 'é€šå‹¤æ‰‹å½“' }
        ];
        let salaryData = JSON.parse(localStorage.getItem('salaryData')) || [];
        let currentCSV = '';

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé …ç›®ã‚’ä¿å­˜
            if (JSON.parse(localStorage.getItem('salaryItems')) === null) {
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
            }
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¾©å…ƒ
            const savedEmail = localStorage.getItem('savedEmailAddress');
            if (savedEmail) {
                document.getElementById('emailTo').value = savedEmail;
            }
            
            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            document.getElementById('emailTo').addEventListener('input', function() {
                const emailValue = this.value.trim();
                if (emailValue) {
                    localStorage.setItem('savedEmailAddress', emailValue);
                }
            });
            
            displayEmployees();
            displayItems();
            displaySalaryData();
            updateEmployeeSelect();
            updateSalaryInputs();
            updateSummary();
            
            // ç¾åœ¨ã®æœˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salaryMonth').value = currentMonth;
            document.getElementById('csvMonth').value = currentMonth;
            document.getElementById('emailMonth').value = currentMonth;
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'employees') {
                displayEmployees();
            } else if (tabName === 'items') {
                displayItems();
            } else if (tabName === 'salary') {
                updateEmployeeSelect();
                updateSalaryInputs();
            } else if (tabName === 'data') {
                displaySalaryData();
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                document.getElementById('importSection').style.display = 'none';
            } else if (tabName === 'generate') {
                updateSummary();
            }
        }

        // å¾“æ¥­å“¡ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('employeeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editEmployeeId').value;
            
            if (editId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                const employeeIndex = employees.findIndex(emp => emp.id == editId);
                if (employeeIndex >= 0) {
                    employees[employeeIndex] = {
                        ...employees[employeeIndex],
                        name: document.getElementById('empName').value,
                        employeeId: document.getElementById('empId').value,
                        gender: document.getElementById('empGender').value,
                        birthDate: document.getElementById('empBirthDate').value,
                        department: document.getElementById('empDepartment').value,
                        position: document.getElementById('empPosition').value,
                        postalCode: document.getElementById('empPostalCode').value,
                        address: document.getElementById('empAddress').value
                    };

                    localStorage.setItem('employees', JSON.stringify(employees));
                    showAlert('å¾“æ¥­å“¡æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', 'success');
                    clearEmployeeForm();
                    displayEmployees();
                    updateEmployeeSelect();
                }
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const employee = {
                    id: Date.now(),
                    name: document.getElementById('empName').value,
                    employeeId: document.getElementById('empId').value,
                    gender: document.getElementById('empGender').value,
                    birthDate: document.getElementById('empBirthDate').value,
                    department: document.getElementById('empDepartment').value,
                    position: document.getElementById('empPosition').value,
                    postalCode: document.getElementById('empPostalCode').value,
                    address: document.getElementById('empAddress').value,
                    spouse: [],
                    dependents: [],
                    createdAt: new Date().toISOString()
                };

                employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(employees));

                showAlert('å¾“æ¥­å“¡ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚', 'success');
                clearEmployeeForm();
                displayEmployees();
                updateEmployeeSelect();
            }
        });

        // å¾“æ¥­å“¡ç·¨é›†
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('empName').value = employee.name;
            document.getElementById('empId').value = employee.employeeId;
            document.getElementById('empGender').value = employee.gender || '';
            document.getElementById('empBirthDate').value = employee.birthDate || '';
            document.getElementById('empDepartment').value = employee.department || '';
            document.getElementById('empPosition').value = employee.position || '';
            document.getElementById('empPostalCode').value = employee.postalCode || '';
            document.getElementById('empAddress').value = employee.address || '';

            // ãƒœã‚¿ãƒ³ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
            document.getElementById('employeeSubmitBtn').textContent = 'å¾“æ¥­å“¡ã‚’æ›´æ–°';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('employeeForm').scrollIntoView({ behavior: 'smooth' });
        }

        // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            clearEmployeeForm();
        }

        // å®¶æ—ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('familyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const familyMember = {
                id: document.getElementById('familyId').value || Date.now(),
                name: document.getElementById('familyName').value,
                gender: document.getElementById('familyGender').value,
                birthDate: document.getElementById('familyBirthDate').value,
                postalCode: document.getElementById('familyPostalCode').value,
                address: document.getElementById('familyAddress').value
            };

            const employeeId = parseInt(document.getElementById('familyEmployeeId').value);
            const familyType = document.getElementById('familyType').value;
            const employee = employees.find(emp => emp.id === employeeId);

            if (employee) {
                if (familyType === 'spouse') {
                    const existingIndex = employee.spouse.findIndex(s => s.id == familyMember.id);
                    if (existingIndex >= 0) {
                        employee.spouse[existingIndex] = familyMember;
                    } else {
                        employee.spouse.push(familyMember);
                    }
                } else if (familyType === 'dependent') {
                    const existingIndex = employee.dependents.findIndex(d => d.id == familyMember.id);
                    if (existingIndex >= 0) {
                        employee.dependents[existingIndex] = familyMember;
                    } else {
                        employee.dependents.push(familyMember);
                    }
                }

                localStorage.setItem('employees', JSON.stringify(employees));
                displayEmployees();
                showAlert('å®¶æ—æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
                closeFamilyModal();
            }
        });

        // é …ç›®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('itemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const item = {
                id: Date.now(),
                name: document.getElementById('itemName').value,
                type: document.getElementById('itemType').value,
                description: document.getElementById('itemDescription').value,
                createdAt: new Date().toISOString()
            };

            salaryItems.push(item);
            localStorage.setItem('salaryItems', JSON.stringify(salaryItems));

            showAlert('çµ¦æ–™é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚', 'success');
            clearItemForm();
            displayItems();
            updateSalaryInputs();
        });

        // çµ¦æ–™ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('salaryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedEmployeeId = document.getElementById('selectedEmployee').value;
            const month = document.getElementById('salaryMonth').value;
            
            if (!selectedEmployeeId) {
                showAlert('å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            const employee = employees.find(emp => emp.id == selectedEmployeeId);
            if (!employee) {
                showAlert('é¸æŠã•ã‚ŒãŸå¾“æ¥­å“¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const salaryInputs = document.querySelectorAll('#salaryInputs input[type="number"]');
            const salaryDataItem = {
                id: Date.now(),
                employeeId: selectedEmployeeId,
                employeeName: employee.name,
                employeeEmployeeId: employee.employeeId,
                month: month,
                items: {},
                totalIncome: 0,
                totalDeduction: 0,
                netSalary: 0,
                createdAt: new Date().toISOString()
            };

            salaryItems.forEach(item => {
                const input = document.getElementById(`salary_${item.id}`);
                if (input) {
                    const value = parseFloat(input.value) || 0;
                    salaryDataItem.items[item.id] = value;
                    
                    if (item.type === 'income') {
                        salaryDataItem.totalIncome += value;
                    } else if (item.type === 'deduction') {
                        salaryDataItem.totalDeduction += value;
                    }
                    // å‹¤æ€ é …ç›®ã¯è¨ˆç®—ã«å«ã‚ãªã„
                }
            });

            salaryDataItem.netSalary = salaryDataItem.totalIncome - salaryDataItem.totalDeduction;

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã¾ãŸã¯æ–°è¦è¿½åŠ 
            const existingIndex = salaryData.findIndex(data => 
                data.employeeId == selectedEmployeeId && data.month === month
            );

            if (existingIndex >= 0) {
                salaryData[existingIndex] = salaryDataItem;
            } else {
                salaryData.push(salaryDataItem);
            }

            localStorage.setItem('salaryData', JSON.stringify(salaryData));

            // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒœã‚¿ãƒ³è¿‘ãã«è¡¨ç¤º
            const submitBtn = document.querySelector('#salaryForm button[type="submit"]');
            const successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success';
            successMessage.textContent = 'çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
            successMessage.style.marginTop = '10px';
            successMessage.style.marginBottom = '10px';
            
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMessage = submitBtn.parentNode.querySelector('.alert-success');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // ãƒœã‚¿ãƒ³ã®å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ¿å…¥
            submitBtn.parentNode.insertBefore(successMessage, submitBtn.nextSibling);
            
            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.remove();
                }
            }, 3000);
            
            displaySalaryData();
        });

        // çµ¦æ–™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSalaryData() {
            const selectedEmployeeId = document.getElementById('selectedEmployee').value;
            const month = document.getElementById('salaryMonth').value;
            
            if (!selectedEmployeeId || !month) {
                return;
            }

            const existingData = salaryData.find(data => 
                data.employeeId == selectedEmployeeId && data.month === month
            );

            if (existingData) {
                // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
                salaryItems.forEach(item => {
                    const input = document.getElementById(`salary_${item.id}`);
                    if (input) {
                        input.value = existingData.items[item.id] || '';
                    }
                });
                showAlert('ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚', 'success');
            } else {
                // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                salaryItems.forEach(item => {
                    const input = document.getElementById(`salary_${item.id}`);
                    if (input) {
                        input.value = '';
                    }
                });
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢é–¢æ•°
        function clearEmployeeForm() {
            document.getElementById('employeeForm').reset();
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('employeeSubmitBtn').textContent = 'å¾“æ¥­å“¡ã‚’è¿½åŠ ';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function clearItemForm() {
            document.getElementById('itemForm').reset();
        }

        function clearSalaryForm() {
            document.getElementById('salaryForm').reset();
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('salaryMonth').value = currentMonth;
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            const inputs = document.querySelectorAll('#salaryInputs input[type="number"]');
            inputs.forEach(input => input.value = '');
        }

        // å¾“æ¥­å“¡ä¸€è¦§è¡¨ç¤º
        function displayEmployees() {
            const listContainer = document.getElementById('employeeList');
            
            if (employees.length === 0) {
                listContainer.innerHTML = '<p>å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            listContainer.innerHTML = employees.map(emp => {
                let html = `
                    <div class="employee-item">
                        <div class="employee-header">
                            <div class="employee-info">
                                <div class="employee-name">${emp.name} (${emp.employeeId})</div>
                                <div class="employee-details">
                                    ${emp.gender} | ${emp.birthDate} | ${emp.department} | ${emp.position}<br>
                                    ã€’${emp.postalCode} | ${emp.address}
                                </div>
                            </div>
                            <div class="employee-actions">
                                <button class="btn btn-small btn-secondary" onclick="editEmployee(${emp.id})">ç·¨é›†</button>
                                <button class="btn btn-small btn-danger" onclick="deleteEmployee(${emp.id})">å‰Šé™¤</button>
                            </div>
                        </div>
                `;

                // é…å¶è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                if (emp.spouse && emp.spouse.length > 0) {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">é…å¶è€…</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'spouse')">è¿½åŠ </button>
                            </div>
                            <div class="family-list">
                    `;
                    emp.spouse.forEach(spouse => {
                        html += `
                            <div class="family-item">
                                <div class="family-info">
                                    <div class="family-name">${spouse.name}</div>
                                    <div class="family-details">
                                        ${spouse.gender} | ${spouse.birthDate} | ã€’${spouse.postalCode} | ${spouse.address}
                                    </div>
                                </div>
                                <div class="family-actions">
                                    <button class="btn btn-xs btn-secondary" onclick="editFamily(${emp.id}, 'spouse', ${spouse.id})">ç·¨é›†</button>
                                    <button class="btn btn-xs btn-danger" onclick="deleteFamily(${emp.id}, 'spouse', ${spouse.id})">å‰Šé™¤</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                } else {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">é…å¶è€…</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'spouse')">è¿½åŠ </button>
                            </div>
                        </div>
                    `;
                }

                // æ‰¶é¤Šè¦ªæ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                if (emp.dependents && emp.dependents.length > 0) {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">æ‰¶é¤Šè¦ªæ—</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'dependent')">è¿½åŠ </button>
                            </div>
                            <div class="family-list">
                    `;
                    emp.dependents.forEach(dependent => {
                        html += `
                            <div class="family-item">
                                <div class="family-info">
                                    <div class="family-name">${dependent.name}</div>
                                    <div class="family-details">
                                        ${dependent.gender} | ${dependent.birthDate} | ã€’${dependent.postalCode} | ${dependent.address}
                                    </div>
                                </div>
                                <div class="family-actions">
                                    <button class="btn btn-xs btn-secondary" onclick="editFamily(${emp.id}, 'dependent', ${dependent.id})">ç·¨é›†</button>
                                    <button class="btn btn-xs btn-danger" onclick="deleteFamily(${emp.id}, 'dependent', ${dependent.id})">å‰Šé™¤</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                } else {
                    html += `
                        <div class="family-section">
                            <div class="family-header">
                                <div class="family-title">æ‰¶é¤Šè¦ªæ—</div>
                                <button class="btn btn-xs btn-success" onclick="addFamily(${emp.id}, 'dependent')">è¿½åŠ </button>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                return html;
            }).join('');
        }

        // å®¶æ—è¿½åŠ ãƒ»ç·¨é›†
        function addFamily(employeeId, type) {
            document.getElementById('familyModalTitle').textContent = type === 'spouse' ? 'é…å¶è€…è¿½åŠ ' : 'æ‰¶é¤Šè¦ªæ—è¿½åŠ ';
            document.getElementById('familyEmployeeId').value = employeeId;
            document.getElementById('familyType').value = type;
            document.getElementById('familyId').value = '';
            document.getElementById('familyForm').reset();
            document.getElementById('familyModal').style.display = 'block';
        }

        function editFamily(employeeId, type, familyId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            const familyList = type === 'spouse' ? employee.spouse : employee.dependents;
            const family = familyList.find(f => f.id == familyId);
            if (!family) return;

            document.getElementById('familyModalTitle').textContent = type === 'spouse' ? 'é…å¶è€…ç·¨é›†' : 'æ‰¶é¤Šè¦ªæ—ç·¨é›†';
            document.getElementById('familyEmployeeId').value = employeeId;
            document.getElementById('familyType').value = type;
            document.getElementById('familyId').value = familyId;
            document.getElementById('familyName').value = family.name;
            document.getElementById('familyGender').value = family.gender;
            document.getElementById('familyBirthDate').value = family.birthDate;
            document.getElementById('familyPostalCode').value = family.postalCode;
            document.getElementById('familyAddress').value = family.address;
            document.getElementById('familyModal').style.display = 'block';
        }

        function deleteFamily(employeeId, type, familyId) {
            if (!confirm('ã“ã®å®¶æ—æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;

            if (type === 'spouse') {
                employee.spouse = employee.spouse.filter(s => s.id != familyId);
            } else {
                employee.dependents = employee.dependents.filter(d => d.id != familyId);
            }

            localStorage.setItem('employees', JSON.stringify(employees));
            displayEmployees();
            showAlert('å®¶æ—æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
        }

        function closeFamilyModal() {
            document.getElementById('familyModal').style.display = 'none';
        }

        // é …ç›®ä¸€è¦§è¡¨ç¤º
        function displayItems() {
            const listContainer = document.getElementById('itemList');
            
            if (salaryItems.length === 0) {
                listContainer.innerHTML = '<p>çµ¦æ–™é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            const typeLabels = {
                'attendance': 'å‹¤æ€ é …ç›®',
                'income': 'åå…¥é …ç›®',
                'deduction': 'æ§é™¤é …ç›®'
            };

            const typeClasses = {
                'attendance': 'type-attendance',
                'income': 'type-income',
                'deduction': 'type-deduction'
            };

            listContainer.innerHTML = salaryItems.map(item => `
                <div class="salary-item">
                    <div class="item-info">
                        <div class="item-name">
                            ${item.name}
                            <span class="type-badge ${typeClasses[item.type]}">${typeLabels[item.type]}</span>
                        </div>
                        <div class="item-details">
                            ${item.description}
                        </div>
                    </div>
                                         <div class="item-actions">
                         <button class="btn btn-small btn-danger" onclick="deleteItem(${item.id})">å‰Šé™¤</button>
                     </div>
                </div>
            `).join('');
        }

        // çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ä¸€è¦§è¡¨ç¤º
        function displaySalaryData() {
            const listContainer = document.getElementById('salaryDataList');
            
            if (salaryData.length === 0) {
                listContainer.innerHTML = '<p>çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            listContainer.innerHTML = salaryData.map(data => `
                <div class="salary-data-item">
                    <div class="salary-data-info">
                        <div class="salary-data-name">${data.employeeName} (${data.employeeEmployeeId})</div>
                        <div class="salary-data-details">
                            ${data.month} | ç·åå…¥: Â¥${data.totalIncome.toLocaleString()} | 
                            ç·æ§é™¤: Â¥${data.totalDeduction.toLocaleString()} | 
                            æ‰‹å–ã‚Š: Â¥${data.netSalary.toLocaleString()}
                        </div>
                    </div>
                                         <div class="salary-data-actions">
                         <button class="btn btn-small btn-danger" onclick="deleteSalaryData(${data.id})">å‰Šé™¤</button>
                     </div>
                </div>
            `).join('');
        }

        // å¾“æ¥­å“¡é¸æŠã‚³ãƒ³ãƒœãƒœãƒƒã‚¯ã‚¹æ›´æ–°
        function updateEmployeeSelect() {
            const select = document.getElementById('selectedEmployee');
            select.innerHTML = '<option value="">å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.name} (${emp.employeeId})`;
                select.appendChild(option);
            });
        }

        // çµ¦æ–™å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ›´æ–°
        function updateSalaryInputs() {
            const container = document.getElementById('salaryInputs');
            
            if (salaryItems.length === 0) {
                container.innerHTML = '<h3>çµ¦æ–™é …ç›®</h3><p>é …ç›®ç®¡ç†ã‚¿ãƒ–ã§é …ç›®ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            let html = '<h3>çµ¦æ–™é …ç›®</h3>';
            
            // é …ç›®ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«åˆ†é¡
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');

            // å‹¤æ€ é …ç›®
            if (attendanceItems.length > 0) {
                html += '<div class="section-header">ğŸ“Š å‹¤æ€ é …ç›®</div>';
                attendanceItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            // åå…¥é …ç›®
            if (incomeItems.length > 0) {
                html += '<div class="section-header">ğŸ’° åå…¥é …ç›®</div>';
                incomeItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            // æ§é™¤é …ç›®
            if (deductionItems.length > 0) {
                html += '<div class="section-header">ğŸ’¸ æ§é™¤é …ç›®</div>';
                deductionItems.forEach(item => {
                    html += `
                        <div class="salary-input-row">
                            <div class="salary-input-group">
                                <label for="salary_${item.id}">${item.name}</label>
                                <input type="number" id="salary_${item.id}" min="0" step="0.01" placeholder="${item.description}">
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // å‰Šé™¤é–¢æ•°
        function deleteEmployee(id) {
            if (confirm('ã“ã®å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                employees = employees.filter(emp => emp.id !== id);
                salaryData = salaryData.filter(data => data.employeeId != id);
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displayEmployees();
                displaySalaryData();
                updateEmployeeSelect();
                showAlert('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            }
        }

        function deleteItem(id) {
            if (confirm('ã“ã®çµ¦æ–™é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                salaryItems = salaryItems.filter(item => item.id !== id);
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
                displayItems();
                updateSalaryInputs();
                showAlert('çµ¦æ–™é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            }
        }

        function deleteSalaryData(id) {
            if (confirm('ã“ã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                salaryData = salaryData.filter(data => data.id !== id);
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displaySalaryData();
                showAlert('çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            }
        }

        // å…¨çµ¦æ–™ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function deleteAllSalaryData() {
            if (confirm('å…¨ã¦ã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                salaryData = [];
                localStorage.setItem('salaryData', JSON.stringify(salaryData));
                displaySalaryData();
                showAlert('å…¨ã¦ã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            }
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAllData() {
            generateBackupJSON();
        }

        // JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”Ÿæˆ
        function generateBackupJSON() {
            const exportData = {
                employees: employees,
                salaryItems: salaryItems,
                salaryData: salaryData,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toISOString().slice(0, 10)}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        let importDataContent = null;

        function importData() {
            document.getElementById('importSection').style.display = 'block';
            document.getElementById('importFile').value = '';
            document.getElementById('confirmImportBtn').style.display = 'none';
            importDataContent = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œè¨¼
                    if (!data.employees || !data.salaryItems || !data.salaryData) {
                        showAlert('ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚æ­£ã—ã„å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                        return;
                    }

                    importDataContent = data;
                    document.getElementById('confirmImportBtn').style.display = 'inline-block';
                    
                    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…å®¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    const preview = `
                        ã‚¤ãƒ³ãƒãƒ¼ãƒˆå†…å®¹:
                        - å¾“æ¥­å“¡: ${data.employees.length}ä»¶
                        - çµ¦æ–™é …ç›®: ${data.salaryItems.length}ä»¶
                        - çµ¦æ–™ãƒ‡ãƒ¼ã‚¿: ${data.salaryData.length}ä»¶
                        - ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚: ${data.exportedAt ? new Date(data.exportedAt).toLocaleString() : 'ä¸æ˜'}
                    `;
                    showAlert(preview, 'success');
                    
                } catch (error) {
                    showAlert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„å½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            };
            reader.readAsText(file);
        }

        function confirmImport() {
            if (!importDataContent) {
                showAlert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
                employees = importDataContent.employees || [];
                salaryItems = importDataContent.salaryItems || [];
                salaryData = importDataContent.salaryData || [];

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('employees', JSON.stringify(employees));
                localStorage.setItem('salaryItems', JSON.stringify(salaryItems));
                localStorage.setItem('salaryData', JSON.stringify(salaryData));

                // UIã‚’æ›´æ–°
                displayEmployees();
                displayItems();
                displaySalaryData();
                updateEmployeeSelect();
                updateSalaryInputs();
                updateSummary();

                showAlert('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
                cancelImport();
            }
        }

        function cancelImport() {
            document.getElementById('importSection').style.display = 'none';
            document.getElementById('importFile').value = '';
            document.getElementById('confirmImportBtn').style.display = 'none';
            importDataContent = null;
        }



        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSummary() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                return;
            }

            const totalEmployees = new Set(filteredData.map(data => data.employeeId)).size;
            const totalSalary = filteredData.reduce((sum, data) => sum + data.netSalary, 0);
            const avgSalary = totalSalary / filteredData.length;

            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('totalSalary').textContent = `Â¥${totalSalary.toLocaleString()}`;
            document.getElementById('avgSalary').textContent = `Â¥${Math.round(avgSalary).toLocaleString()}`;
            document.getElementById('summaryCard').style.display = 'block';
        }

        // CSVç”Ÿæˆ
        function generateCSV() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                showAlert('æŒ‡å®šã•ã‚ŒãŸæœˆã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // é …ç›®ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«ä¸¦ã³æ›¿ãˆ
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['å¾“æ¥­å“¡ID', 'æ°å'];
            
            // é …ç›®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ï¼ˆä¸¦ã³é †é€šã‚Šï¼‰
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [
                    data.employeeEmployeeId,
                    data.employeeName
                ];

                // å„é …ç›®ã®å€¤ã‚’è¿½åŠ ï¼ˆä¸¦ã³é †é€šã‚Šï¼‰
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });

                return row;
            });

            const csv = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            currentCSV = csv;

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const fileName = selectedMonth ? 
                `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv` : 
                `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚', 'success');
        }

        // CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewCSV() {
            const selectedMonth = document.getElementById('csvMonth').value;
            let filteredData = salaryData;
            
            if (selectedMonth) {
                filteredData = salaryData.filter(data => data.month === selectedMonth);
            }

            if (filteredData.length === 0) {
                showAlert('æŒ‡å®šã•ã‚ŒãŸæœˆã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // é …ç›®ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«ä¸¦ã³æ›¿ãˆ
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['å¾“æ¥­å“¡ID', 'æ°å', 'ç·åå…¥', 'ç·æ§é™¤', 'æ‰‹å–ã‚Šçµ¦æ–™'];
            
            // é …ç›®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ï¼ˆä¸¦ã³é †é€šã‚Šï¼‰
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [
                    data.employeeEmployeeId,
                    data.employeeName,
                    data.totalIncome,
                    data.totalDeduction,
                    data.netSalary
                ];

                // å„é …ç›®ã®å€¤ã‚’è¿½åŠ ï¼ˆä¸¦ã³é †é€šã‚Šï¼‰
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });

                return row;
            });

            // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            const table = document.getElementById('csvTable');
            let tableHTML = '<thead><tr>';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            csvData.forEach(row => {
                tableHTML += '<tr>';
                row.forEach((cell, index) => {
                    if (index >= 2 && index <= 4) {
                        // é‡‘é¡åˆ—ã¯é€šè²¨å½¢å¼ã§è¡¨ç¤º
                        tableHTML += `<td>Â¥${parseFloat(cell).toLocaleString()}</td>`;
                    } else {
                        tableHTML += `<td>${cell}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;

            document.getElementById('csvPreview').style.display = 'block';
            showAlert('CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚', 'success');
        }

        // ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        function createEmailFiles() {
            const selectedMonth = document.getElementById('emailMonth').value;
            
            if (!selectedMonth) {
                showAlert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            let filteredData = salaryData.filter(data => data.month === selectedMonth);
            
            if (filteredData.length === 0) {
                showAlert('æŒ‡å®šã•ã‚ŒãŸæœˆã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // 1. çµ¦æ–™ãƒ‡ãƒ¼ã‚¿CSVã‚’ä½œæˆ
            const salaryCSV = createSalaryCSV(filteredData);
            
            // 2. å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿CSVã‚’ä½œæˆ
            const employeeCSV = createEmployeeCSV();
            
            // 3. é…å¶è€…ãƒ‡ãƒ¼ã‚¿CSVã‚’ä½œæˆ
            const spouseCSV = createSpouseCSV();
            
            // 4. æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿CSVã‚’ä½œæˆ
            const dependentCSV = createDependentCSV();
            
            // 5. å…¨ãƒ‡ãƒ¼ã‚¿JSONã‚’ä½œæˆ
            const allDataJSON = createAllDataJSON(filteredData, selectedMonth);

            // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            createZIPFile(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth);
        }

        // çµ¦æ–™ãƒ‡ãƒ¼ã‚¿CSVä½œæˆ
        function createSalaryCSV(filteredData) {
            const attendanceItems = salaryItems.filter(item => item.type === 'attendance');
            const incomeItems = salaryItems.filter(item => item.type === 'income');
            const deductionItems = salaryItems.filter(item => item.type === 'deduction');
            const orderedItems = [...attendanceItems, ...incomeItems, ...deductionItems];

            const headers = ['å¾“æ¥­å“¡ID', 'æ°å'];
            orderedItems.forEach(item => {
                headers.push(item.name);
            });

            const csvData = filteredData.map(data => {
                const row = [data.employeeEmployeeId, data.employeeName];
                orderedItems.forEach(item => {
                    row.push(data.items[item.id] || 0);
                });
                return row;
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿CSVä½œæˆ
        function createEmployeeCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒ¨ç½²', 'å½¹è·', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            const csvData = employees.map(emp => [
                emp.employeeId,
                emp.name,
                emp.gender,
                emp.birthDate,
                emp.department,
                emp.position,
                emp.postalCode,
                emp.address
            ]);

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // é…å¶è€…ãƒ‡ãƒ¼ã‚¿CSVä½œæˆ
        function createSpouseCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'å¾“æ¥­å“¡æ°å', 'é…å¶è€…æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            const csvData = [];
            
            employees.forEach(emp => {
                if (emp.spouse && emp.spouse.length > 0) {
                    emp.spouse.forEach(spouse => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            spouse.name,
                            spouse.gender,
                            spouse.birthDate,
                            spouse.postalCode,
                            spouse.address
                        ]);
                    });
                }
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿CSVä½œæˆ
        function createDependentCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'å¾“æ¥­å“¡æ°å', 'æ‰¶é¤Šè¦ªæ—æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            const csvData = [];
            
            employees.forEach(emp => {
                if (emp.dependents && emp.dependents.length > 0) {
                    emp.dependents.forEach(dependent => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            dependent.name,
                            dependent.gender,
                            dependent.birthDate,
                            dependent.postalCode,
                            dependent.address
                        ]);
                    });
                }
            });

            return [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿JSONä½œæˆ
        function createAllDataJSON(filteredData, selectedMonth) {
            return JSON.stringify({
                employees: employees,
                salaryItems: salaryItems,
                salaryData: filteredData,
                selectedMonth: selectedMonth,
                exportedAt: new Date().toISOString()
            }, null, 2);
        }

        // ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        function createZIPFile(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth) {
            // JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            if (typeof JSZip === 'undefined') {
                // JSZipãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                downloadIndividualFiles(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth);
                return;
            }

            const zip = new JSZip();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«è¿½åŠ 
            zip.file(`çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, '\uFEFF' + salaryCSV);
            zip.file(`å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, '\uFEFF' + employeeCSV);
            zip.file(`é…å¶è€…ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, '\uFEFF' + spouseCSV);
            zip.file(`æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, '\uFEFF' + dependentCSV);
            zip.file(`å…¨ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.json`, allDataJSON);

            // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const link = document.createElement('a');
                const url = URL.createObjectURL(content);
                link.setAttribute('href', url);
                link.setAttribute('download', `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${selectedMonth}_${new Date().toISOString().slice(0, 10)}.zip`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚æ¬¡ã«ã€Œ2. ãƒ¡ãƒ¼ãƒ«ã‚½ãƒ•ãƒˆèµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'success');
            });
        }

        // å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆJSZipãŒåˆ©ç”¨ã§ããªã„å ´åˆï¼‰
        function downloadIndividualFiles(salaryCSV, employeeCSV, spouseCSV, dependentCSV, allDataJSON, selectedMonth) {
            const files = [
                { content: '\uFEFF' + salaryCSV, filename: `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + employeeCSV, filename: `å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + spouseCSV, filename: `é…å¶è€…ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, type: 'text/csv' },
                { content: '\uFEFF' + dependentCSV, filename: `æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv`, type: 'text/csv' },
                { content: allDataJSON, filename: `å…¨ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.json`, type: 'application/json' }
            ];

            files.forEach(file => {
                const blob = new Blob([file.content], { type: file.type });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', file.filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            showAlert('5ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚æ¬¡ã«ã€Œ2. ãƒ¡ãƒ¼ãƒ«ã‚½ãƒ•ãƒˆèµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚', 'success');
        }

        // ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèµ·å‹•
        function launchEmailClient() {
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const selectedMonth = document.getElementById('emailMonth').value;

            if (!to) {
                showAlert('é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!selectedMonth) {
                showAlert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('savedEmailAddress', to);

            // ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ä½œæˆ
            const body = `çµ¦æ–™ãƒ‡ãƒ¼ã‚¿ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚

æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼š
1. çµ¦æ–™ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv - å¯¾è±¡æœˆã®çµ¦æ–™ãƒ‡ãƒ¼ã‚¿
2. å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv - å¾“æ¥­å“¡æƒ…å ±
3. é…å¶è€…ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv - é…å¶è€…æƒ…å ±
4. æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.csv - æ‰¶é¤Šè¦ªæ—æƒ…å ±
5. å…¨ãƒ‡ãƒ¼ã‚¿_${selectedMonth}.json - å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰

å¯¾è±¡æœˆ: ${selectedMonth}
ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${salaryData.filter(data => data.month === selectedMonth).length}ä»¶
å¾“æ¥­å“¡æ•°: ${employees.length}å
é …ç›®æ•°: ${salaryItems.length}å€‹

ã”ç¢ºèªã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

            // ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•
            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            showAlert('ãƒ¡ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚', 'success');
        }



        // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿CSVç”Ÿæˆ
        function generateEmployeeCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒ¨ç½²', 'å½¹è·', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            
            const csvData = employees.map(emp => [
                emp.employeeId,
                emp.name,
                emp.gender,
                emp.birthDate,
                emp.department,
                emp.position,
                emp.postalCode,
                emp.address
            ]);

            const csv = [headers, ...csvData]
                .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                .join('\n');

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // é…å¶è€…ãƒ‡ãƒ¼ã‚¿CSVç”Ÿæˆ
        function generateSpouseCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'å¾“æ¥­å“¡æ°å', 'é…å¶è€…æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            
            const csvData = [];
            employees.forEach(emp => {
                if (emp.spouse && emp.spouse.length > 0) {
                    emp.spouse.forEach(spouse => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            spouse.name,
                            spouse.gender,
                            spouse.birthDate,
                            spouse.postalCode,
                            spouse.address
                        ]);
                    });
                }
            });

            if (csvData.length > 0) {
                const csv = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                    .join('\n');

                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `é…å¶è€…ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿CSVç”Ÿæˆ
        function generateDependentCSV() {
            const headers = ['å¾“æ¥­å“¡ID', 'å¾“æ¥­å“¡æ°å', 'æ‰¶é¤Šè¦ªæ—æ°å', 'æ€§åˆ¥', 'ç”Ÿå¹´æœˆæ—¥', 'éƒµä¾¿ç•ªå·', 'ä½æ‰€'];
            
            const csvData = [];
            employees.forEach(emp => {
                if (emp.dependents && emp.dependents.length > 0) {
                    emp.dependents.forEach(dependent => {
                        csvData.push([
                            emp.employeeId,
                            emp.name,
                            dependent.name,
                            dependent.gender,
                            dependent.birthDate,
                            dependent.postalCode,
                            dependent.address
                        ]);
                    });
                }
            });

            if (csvData.length > 0) {
                const csv = [headers, ...csvData]
                    .map(row => row.map(cell => `"${cell || ''}"`).join(','))
                    .join('\n');

                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `æ‰¶é¤Šè¦ªæ—ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // ç›´æ¥é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showDirectSubmitModal() {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰UserIdã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            if (!userId) {
                showAlert('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«userIdãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
            const summary = `
                <strong>ğŸ“Š é€ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚µãƒãƒªãƒ¼</strong><br>
                â€¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${userId}<br>
                â€¢ å¾“æ¥­å“¡æ•°: ${employees.length}å<br>
                â€¢ çµ¦æ–™ãƒ‡ãƒ¼ã‚¿: ${salaryData.length}ä»¶<br>
                â€¢ çµ¦æ–™é …ç›®: ${salaryItems.length}å€‹<br>
                â€¢ æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString()}
            `;
            document.getElementById('directSubmitDataSummary').innerHTML = summary;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('directSubmitModal').style.display = 'block';
        }

        // ç›´æ¥é€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDirectSubmitModal() {
            document.getElementById('directSubmitModal').style.display = 'none';
            document.getElementById('directSubmitPassword').value = '';
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥é€ä¿¡
        function submitDataDirectly() {
            const password = document.getElementById('directSubmitPassword').value;
            
            if (!password) {
                showAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰UserIdã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            if (!userId) {
                showAlert('URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«userIdãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            // æœ¬ç•ªç”¨GASã®URL
            const webhookUrl = 'https://script.google.com/macros/s/AKfycbwl_jL4zt1PlHsGpz0SauH1PKRBotSOKEP98uAHu3sSzuvmLY0fJJEe2qO2UZIzKXUD/exec';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨åŒã˜å½¢å¼ï¼‰
            const data = {
                employees: employees,
                salaryItems: salaryItems,
                salaryData: salaryData,
                auth: {
                    userId: userId,
                    password: password,
                    applicationName: 'çµ¦æ–™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ '
                },
                metadata: {
                    submittedAt: new Date().toISOString()
                }
            };
            
            // é€ä¿¡å®Ÿè¡Œ
            submitToGoogleAppsScript(webhookUrl, data);
        }

        // Google Apps Scriptå¯¾å¿œã®é€ä¿¡é–¢æ•°
        function submitToGoogleAppsScript(webhookUrl, data) {
            try {
                console.log('ãƒ‡ãƒ¼ã‚¿é€ä¿¡é–‹å§‹:', webhookUrl);
                console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦é€ä¿¡ï¼ˆç‰¹æ®Šæ–‡å­—å¯¾å¿œï¼‰
                const jsonString = JSON.stringify(data);
                const encodedData = btoa(unescape(encodeURIComponent(jsonString)));
                
                // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ–¹å¼ã‚’ä½¿ç”¨ï¼ˆCORSå•é¡Œã‚’å›é¿ï¼‰
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = webhookUrl;
                form.target = 'hiddenFrame'; // éè¡¨ç¤ºãƒ•ãƒ¬ãƒ¼ãƒ ã§é€ä¿¡
                form.style.display = 'none';
                
                // éè¡¨ç¤ºã®iframeã‚’ä½œæˆã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡
                let hiddenFrame = document.getElementById('hiddenFrame');
                if (!hiddenFrame) {
                    hiddenFrame = document.createElement('iframe');
                    hiddenFrame.id = 'hiddenFrame';
                    hiddenFrame.name = 'hiddenFrame';
                    hiddenFrame.style.display = 'none';
                    document.body.appendChild(hiddenFrame);
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦è¿½åŠ 
                const dataField = document.createElement('input');
                dataField.type = 'hidden';
                dataField.name = 'postData';
                dataField.value = encodedData;
                form.appendChild(dataField);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’DOMã«è¿½åŠ ã—ã¦é€ä¿¡
                document.body.appendChild(form);
                form.submit();
                
                // é€ä¿¡å¾Œã®å‡¦ç†
                showAlert('ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚', 'success');
                closeDirectSubmitModal();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’å‰Šé™¤
                setTimeout(() => {
                    if (document.body.contains(form)) {
                        document.body.removeChild(form);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚', 'error');
            }
        }
    </script>
</body>
</html>